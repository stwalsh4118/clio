# 2-5 Implement session tracking logic

[Back to task list](./tasks.md)

## Description

Implement logic to group conversations into sessions with proper boundary detection. Sessions represent a continuous development period and may contain multiple conversations. This component determines when a session starts and ends.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-11-14 22:41:32 | Created | N/A | Proposed | Task file created | System |
| 2025-01-27 01:30:00 | Status Change | Proposed | Done | Task completed - session tracking with SQLite persistence, database package, and daemon integration | System |

## Requirements

1. Group related conversations into sessions
2. Determine session boundaries (time-based or manual)
3. Track session metadata: start time, end time, project, duration
4. Handle multiple concurrent sessions (different projects)
5. Detect when a session ends (inactivity timeout or manual)
6. Assign unique session IDs
7. Persist session state across application restarts
8. Handle session updates (conversations added to existing sessions)

## Implementation Plan

1. Design session tracking service:
   - Location: `internal/cursor/session.go`
   - Package: `cursor`
2. Define session data structure:
   ```go
   type Session struct {
       ID           string
       Project      string
       StartTime    time.Time
       EndTime      *time.Time
       Conversations []Conversation
       LastActivity time.Time
   }
   ```
3. Implement session boundary detection:
   - Time-based: Session ends after X minutes of inactivity (e.g., 30 minutes)
   - Project-based: New session when project changes
   - Manual: Session ends when explicitly closed
4. Implement session manager:
   ```go
   type SessionManager interface {
       GetOrCreateSession(project string) (*Session, error)
       AddConversation(sessionID string, conv Conversation) error
       EndSession(sessionID string) error
       GetActiveSessions() []*Session
   }
   ```
5. Track active sessions:
   - Maintain in-memory map of active sessions
   - Key by project or session ID
6. Implement inactivity timeout:
   - Background goroutine to check for inactive sessions
   - End sessions that exceed timeout threshold
7. Persist session state:
   - Save active sessions to disk (JSON or database)
   - Load sessions on startup
   - Update persisted state when sessions change
8. Handle session updates:
   - Add conversations to existing sessions
   - Update last activity time
   - Extend session end time if needed
9. Write unit tests for session logic

## Test Plan

**Objective**: Verify session tracking correctly groups conversations and detects boundaries.

**Test Scope**:
- Session creation
- Conversation grouping
- Boundary detection
- Inactivity timeout
- Session persistence
- Multiple concurrent sessions

**Environment & Setup**:
- Unit tests with mocked time
- Test with temporary storage for persistence

**Key Test Scenarios**:
1. Create new session for new project
2. Add conversation to existing session
3. Detect session end after inactivity timeout
4. Handle multiple concurrent sessions (different projects)
5. Persist sessions and restore on restart
6. Update session with new conversations
7. End session manually
8. Handle session boundary when project changes

**Success Criteria**:
- Conversations grouped correctly into sessions
- Session boundaries detected correctly
- Inactivity timeout works
- Multiple sessions handled correctly
- Session state persists correctly

## Verification

- [x] Session data structure defined
- [x] Session manager implemented
- [x] Session creation works
- [x] Conversation grouping works
- [x] Boundary detection implemented
- [x] Inactivity timeout implemented
- [x] Multiple concurrent sessions supported
- [x] Session persistence implemented (SQLite database)
- [x] Session restoration on startup works
- [x] Unit tests written and passing

## Files Modified

- `internal/cursor/session.go` (new) - Session tracking implementation
- `internal/cursor/session_test.go` (new) - Unit tests for session tracking
- `internal/db/db.go` (new) - Database initialization and connection management
- `internal/db/migrations.go` (new) - Migration system using pure Go SQLite driver
- `internal/db/migrations_test.go` (new) - Migration tests
- `internal/db/migrations/` (new) - SQL migration files
- `internal/daemon/daemon.go` (updated) - Database initialization on daemon startup
- `docs/api-specs/cursor/cursor-api.md` (updated) - API specification
- `docs/api-specs/infrastructure/infrastructure-api.md` (updated) - Database management API

