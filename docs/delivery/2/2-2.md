# 2-2 Implement Cursor log discovery service

[Back to task list](./tasks.md)

## Description

Enhance the existing Cursor log path validation in the config package to properly validate that the configured path exists, is a directory, and is readable. The path is user-configured via `config.Cursor.LogPath` and should point to the Cursor User directory that contains both `globalStorage` and `workspaceStorage` subdirectories.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-11-14 22:41:32 | Created | N/A | Proposed | Task file created | System |
| 2025-01-27 00:00:00 | Status Change | Proposed | Agreed | Task approved | User |
| 2025-01-27 00:00:00 | Status Change | Agreed | InProgress | Started implementation | AI Agent |
| 2025-01-27 00:00:00 | Status Change | InProgress | Review | Implementation complete, validation enhanced | AI Agent |
| 2025-01-27 00:00:00 | Status Change | Review | Done | Task completed and verified | User |

## Requirements

1. Validate that the configured cursor log path exists
2. Validate that the path is a directory
3. Validate that the directory is readable
4. Require path to be set (not optional)
5. Provide helpful error messages if validation fails
6. Handle edge cases (path doesn't exist, not a directory, permissions issues, etc.)

**Path Structure**:
- The configured `cursor.log_path` should point to the Cursor User directory (e.g., `~/.config/Cursor/User/` on Linux)
- This directory contains:
  - `globalStorage/state.vscdb` - Global conversation database
  - `workspaceStorage/{workspace-hash}/` - Workspace-specific data directories

## Implementation Plan

1. Enhance existing validation function:
   - File: `internal/config/validator.go`
   - Function: `ValidateCursorPath()`
2. Update validation logic:
   - Require path to be set (return error if empty)
   - Check if directory exists using `os.Stat()`
   - Check if path is a directory (not a file)
   - Check if directory is readable using `os.Open()`
   - Return helpful, contextual error messages
3. Update default configuration:
   - File: `internal/config/loader.go`
   - Change default from `~/.cursor` to empty string `""`
   - User must configure this explicitly
4. Update default config creation:
   - File: `internal/config/init.go`
   - Update `CreateDefaultConfig()` to use empty string for cursor log path
5. Update API specification:
   - File: `docs/api-specs/cursor/cursor-api.md`
   - Document that path points to User directory containing `globalStorage/` and `workspaceStorage/`
   - Document relative paths: `{log_path}/globalStorage/state.vscdb` and `{log_path}/workspaceStorage/{hash}/`

## Test Plan

**Objective**: Verify Cursor log directory can be discovered and validated on different platforms.

**Test Scope**:
- Platform detection
- Path resolution
- Directory validation
- Error handling

**Environment & Setup**:
- Unit tests with mocked file system
- Test on actual macOS/Linux if possible

**Key Test Scenarios**:
1. Detect macOS platform and return correct path
2. Detect Linux platform and return correct path
3. Resolve home directory correctly
4. Validate existing directory successfully
5. Return error for non-existent directory
6. Return error for non-readable directory
7. Handle missing home directory gracefully

**Success Criteria**:
- Correct paths returned for each platform
- Validation works correctly
- Error messages are helpful
- Service can be used by other components

## Verification

- [ ] Platform detection implemented
- [ ] macOS path resolution works
- [ ] Linux path resolution works
- [ ] Directory existence validation works
- [ ] Directory readability validation works
- [ ] Error handling implemented
- [ ] Unit tests written and passing
- [ ] Service interface exported
- [ ] Logging added

## Files Modified

- `internal/cursor/discovery.go` (new) - Cursor log discovery service
- `internal/cursor/discovery_test.go` (new) - Unit tests for discovery service
- `docs/api-specs/cursor/cursor-api.md` (new or updated) - API specification for cursor services

