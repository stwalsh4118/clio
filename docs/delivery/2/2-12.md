# 2-12 Replace filesystem watcher with polling mechanism

[Back to task list](./tasks.md)

Replace the filesystem watcher that triggers on every Cursor database write with a configurable polling mechanism that checks for updates every N seconds (default 7 seconds) to prevent Cursor lockups and crashes caused by excessive database reads.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-27 00:00:00 | Created | N/A | Proposed | Task file created | System |
| 2025-01-27 00:00:00 | Status Change | Proposed | InProgress | Started implementation | AI Agent |
| 2025-01-27 00:00:00 | Status Change | InProgress | Review | Implementation complete, all tests passing | AI Agent |
| 2025-01-27 00:00:00 | Status Change | Review | Done | Task completed and verified | User |

## Description

The current filesystem watcher implementation triggers on every Cursor database write event, causing multiple database reads and lock contention that leads to Cursor freezing or crashing. Since real-time updates aren't required (notes are typically reviewed after sessions), we'll replace the watcher with a polling mechanism that checks for updates at configurable intervals.

## Requirements

1. Add configurable polling interval to `CursorConfig` (default: 7 seconds)
2. Create `PollerService` interface to replace `WatcherService`
3. Implement polling mechanism that checks for updates on configurable interval
4. Update `capture.go` to use poller instead of watcher
5. Remove filesystem watcher implementation (`watcher.go` and `watcher_test.go`)
6. Remove `fsnotify` dependency if no longer used
7. Update API specifications to document polling instead of filesystem watching
8. Polling should respect shutdown signals gracefully
9. Polling should handle errors gracefully (log and continue)
10. Polling interval must be >= 1 second (validation)

## Implementation Plan

1. **Configuration Changes**:
   - Add `PollIntervalSeconds int` field to `CursorConfig` struct in `internal/config/config.go`
   - Set default value to 7 seconds in `CreateDefaultConfig()`
   - Add validation to ensure interval is >= 1 second
   - Update `config.example.yaml` with `poll_interval_seconds: 7` under `cursor:` section

2. **Create Poller Service**:
   - Location: `internal/cursor/poller.go`
   - Package: `cursor`
   - Implement `PollerService` interface:
     ```go
     type PollerService interface {
         Start() error
         Stop() error
         Poll() (<-chan struct{}, error) // Returns channel that receives on each poll
     }
     ```
   - `poller` struct fields:
     - `config *config.Config`
     - `updater ConversationUpdater` (to call DetectUpdatedComposers)
     - `interval time.Duration`
     - `ticker *time.Ticker`
     - `done chan struct{}`
     - `started bool`
     - `mu sync.Mutex`
     - `logger logging.Logger`
   - `Start()`: Creates ticker with configured interval, starts goroutine that polls on interval
   - `Stop()`: Stops ticker, closes done channel, waits for goroutine to finish
   - Polling goroutine: Calls `DetectUpdatedComposers()` on each tick and processes updates

3. **Update Capture Service**:
   - File: `internal/cursor/capture.go`
   - Replace `WatcherService` field with `PollerService`
   - Update `initializeComponents()`: Create poller instead of watcher
   - Update `Start()`: Start poller instead of watcher, get poll channel instead of event channel
   - Rename `processEvents()` to `processPolls()`: Handle poll events instead of file events
   - Remove `handleFileEvent()`: Move logic directly into poll processing (call `DetectUpdatedComposers()` and process updates)
   - Update `Stop()`: Stop poller instead of watcher

4. **Remove Watcher Code**:
   - Delete `internal/cursor/watcher.go`
   - Delete `internal/cursor/watcher_test.go`

5. **Update API Specifications**:
   - File: `docs/api-specs/cursor/cursor-api.md`
   - Remove `WatcherService` interface documentation
   - Add `PollerService` interface documentation
   - Update "Update Detection" section to describe polling instead of filesystem watching
   - Document `cursor.poll_interval_seconds` configuration option

6. **Cleanup Dependencies**:
   - File: `go.mod`
   - Remove `github.com/fsnotify/fsnotify` dependency if no longer used elsewhere
   - Run `go mod tidy` to clean up

## Test Plan

**Objective**: Verify polling mechanism correctly detects and processes conversation updates at configured intervals without causing database lock contention.

**Test Scope**:
- Poller service creation and initialization
- Polling interval configuration
- Poll execution on configured interval
- Update detection and processing
- Graceful shutdown
- Error handling

**Environment & Setup**:
- Use test SQLite database for testing
- Mock or use test Cursor database
- Test with various polling intervals

**Key Test Scenarios**:
1. Poller starts successfully with configured interval
2. Poller executes polls at correct interval
3. Poller detects updated composers correctly
4. Poller processes updates correctly
5. Poller respects shutdown signals
6. Poller handles errors gracefully (continues polling after errors)
7. Poller uses default interval (7 seconds) when not configured
8. Poller validates interval is >= 1 second
9. Multiple polls don't cause database lock contention
10. Poller stops gracefully without hanging

**Success Criteria**:
- Polling works at configured interval
- Updates detected correctly
- No excessive database reads
- Graceful shutdown works
- Error handling works correctly
- Configuration validation works

## Verification

- [x] Configuration field added to `CursorConfig`
- [x] Default value set to 7 seconds
- [x] Configuration validation added (>= 1 second)
- [x] `PollerService` interface defined
- [x] Poller implementation created
- [x] Poller starts and stops correctly
- [x] Polling executes at configured interval
- [x] Updates detected and processed correctly
- [x] Capture service updated to use poller
- [x] Watcher code removed
- [x] API specifications updated
- [x] Dependencies cleaned up
- [x] Connection reuse optimization implemented
- [x] Logging improvements implemented

## Files Modified

- `internal/config/config.go` (updated) - Add `PollIntervalSeconds` to `CursorConfig`
- `internal/config/init.go` (updated) - Set default polling interval
- `app/config.example.yaml` (updated) - Add polling interval configuration
- `internal/cursor/poller.go` (new) - Poller service implementation
- `internal/cursor/capture.go` (updated) - Replace watcher with poller
- `internal/cursor/watcher.go` (deleted) - Remove filesystem watcher
- `internal/cursor/watcher_test.go` (deleted) - Remove watcher tests
- `docs/api-specs/cursor/cursor-api.md` (updated) - Update API documentation
- `go.mod` (updated) - Remove fsnotify dependency


