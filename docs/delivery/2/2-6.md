# 2-6 Implement database storage for conversations

[Back to task list](./tasks.md)

## Description

Implement database storage functionality to persist conversation sessions and individual messages in the SQLite database. This component stores structured conversation data with proper relationships to enable efficient querying and retrieval.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-11-14 22:41:32 | Created | N/A | Proposed | Task file created | System |

## Requirements

1. Store conversations in SQLite database
2. Store session metadata in database
3. Store individual messages with proper relationships to conversations and sessions
4. Ensure efficient storage and retrieval
5. Maintain referential integrity between sessions, conversations, and messages
6. Support incremental updates (adding new messages to existing conversations)
7. Handle database transactions properly
8. Ensure data persistence across application restarts

## Implementation Plan

1. Design database schema for conversations and messages:
   - Review PBI-4 database schema requirements
   - Ensure schema supports sessions, conversations, and messages
   - Add `messages` table if not already present in PBI-4 schema
   - Define relationships: sessions → conversations → messages
2. Create database storage service:
   - Location: `internal/cursor/storage.go`
   - Package: `cursor`
3. Define storage interface:
   ```go
   type ConversationStorage interface {
       StoreSession(session *Session) error
       StoreConversation(conversation *Conversation, sessionID string) error
       StoreMessage(message *Message, conversationID string) error
       UpdateConversation(conversationID string, newMessages []*Message) error
       GetSession(sessionID string) (*Session, error)
       GetConversation(conversationID string) (*Conversation, error)
   }
   ```
4. Implement session storage:
   - Insert/update session records in database
   - Handle session metadata (start time, end time, project, duration)
   - Ensure session IDs are unique
5. Implement conversation storage:
   - Insert conversation records linked to sessions
   - Store conversation metadata (composer ID, message count, timestamps)
   - Handle conversation updates (incremental message addition)
6. Implement message storage:
   - Insert individual messages linked to conversations
   - Store message content, role (user/agent), timestamp
   - Preserve message ordering
7. Implement database transactions:
   - Use transactions for atomic operations
   - Handle rollback on errors
   - Ensure referential integrity
8. Integrate with existing session manager:
   - Ensure session manager uses storage service
   - Update session manager to persist to database
9. Write unit tests for storage operations

## Test Plan

**Objective**: Verify database storage correctly persists conversations, sessions, and messages with proper relationships.

**Test Scope**:
- Database schema and table creation
- Session storage and retrieval
- Conversation storage and retrieval
- Message storage and retrieval
- Database transactions
- Referential integrity
- Incremental updates

**Environment & Setup**:
- Use test SQLite database for testing
- Test with sample sessions, conversations, and messages
- Verify database records and relationships

**Key Test Scenarios**:
1. Store session in database correctly
2. Store conversation linked to session correctly
3. Store messages linked to conversation correctly
4. Retrieve session with all related conversations
5. Retrieve conversation with all messages
6. Update conversation with new messages incrementally
7. Handle database transactions correctly (rollback on error)
8. Maintain referential integrity (foreign keys)
9. Handle concurrent writes gracefully
10. Persist data across application restarts
11. Query sessions by project and date range
12. Handle database errors gracefully

**Success Criteria**:
- Sessions stored and retrieved correctly
- Conversations linked to sessions correctly
- Messages linked to conversations correctly
- Database transactions work correctly
- Referential integrity maintained
- Incremental updates work correctly
- Data persists across restarts

## Verification

- [ ] Database schema designed and implemented
- [ ] Storage service implemented
- [ ] Session storage works correctly
- [ ] Conversation storage works correctly
- [ ] Message storage works correctly
- [ ] Database transactions implemented
- [ ] Referential integrity maintained
- [ ] Incremental updates work correctly
- [ ] Unit tests written and passing
- [ ] Data persists correctly

## Files Modified

- `internal/cursor/storage.go` (new) - Database storage implementation
- `internal/cursor/storage_test.go` (new) - Unit tests for storage
- `docs/api-specs/cursor/cursor-api.md` (updated) - API specification

