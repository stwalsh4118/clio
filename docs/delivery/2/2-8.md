# 2-8 Handle conversation updates and modifications

[Back to task list](./tasks.md)

## Description

Handle updates to existing conversations that are modified after initial capture. Cursor may update conversation logs as users continue chatting, and we need to detect these updates and update our exported markdown files accordingly.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-11-14 22:41:32 | Created | N/A | Proposed | Task file created | System |

## Requirements

1. Detect when an existing conversation file is modified
2. Parse updated conversation content
3. Identify new messages added to existing conversation
4. Update existing markdown file with new messages
5. Preserve existing content while appending new content
6. Handle cases where conversation structure changes
7. Track which conversations have been processed to avoid duplicates
8. Handle concurrent updates gracefully

## Implementation Plan

1. Extend watcher service (from task 2-3):
   - Track which files have been processed
   - Detect modification events for existing files
   - Distinguish between new files and modified files
2. Implement update detection:
   - Location: `internal/cursor/updater.go`
   - Package: `cursor`
3. Track processed conversations:
   - Maintain state of processed files (file path + last modified time)
   - Persist state to disk (JSON file or database)
   - Load state on startup
4. Implement incremental parsing:
   - Use parser from task 2-4 with incremental support
   - Only parse new messages since last update
   - Merge new messages with existing conversation
5. Implement markdown update logic:
   - Read existing markdown file
   - Append new messages to end
   - Update session metadata (message count, end time, duration)
   - Preserve existing formatting
6. Handle file updates:
   ```go
   type ConversationUpdater interface {
       ProcessUpdate(filePath string) error
       HasBeenProcessed(filePath string, modTime time.Time) bool
       MarkAsProcessed(filePath string, modTime time.Time) error
   }
   ```
7. Implement atomic updates:
   - Write updated content to temporary file
   - Replace original file atomically
   - Handle errors gracefully
8. Handle edge cases:
   - Conversation file deleted
   - Conversation file corrupted
   - Concurrent modifications
   - Large conversation updates
9. Write unit tests for update handling

## Test Plan

**Objective**: Verify conversation updates are detected and markdown files are updated correctly.

**Test Scope**:
- Update detection
- Incremental parsing
- Markdown file updates
- State tracking
- Concurrent updates

**Environment & Setup**:
- Use temporary directories and files for testing
- Simulate file modifications
- Test with sample conversations

**Key Test Scenarios**:
1. Detect modification to existing conversation file
2. Parse only new messages from update
3. Append new messages to existing markdown file
4. Update session metadata correctly
5. Preserve existing markdown formatting
6. Track processed files correctly
7. Handle file that was already processed
8. Handle concurrent updates gracefully
9. Handle deleted conversation file
10. Handle corrupted conversation file

**Success Criteria**:
- Updates detected correctly
- New messages appended correctly
- Existing content preserved
- State tracking works correctly
- Atomic updates work correctly

## Verification

- [ ] Update detection implemented
- [ ] Processed file tracking implemented
- [ ] Incremental parsing works
- [ ] Markdown update logic implemented
- [ ] New messages appended correctly
- [ ] Session metadata updated correctly
- [ ] Atomic file updates implemented
- [ ] Edge cases handled
- [ ] Unit tests written and passing
- [ ] State persistence works

## Files Modified

- `internal/cursor/updater.go` (new) - Conversation update handling
- `internal/cursor/updater_test.go` (new) - Unit tests for updater
- `internal/cursor/watcher.go` (updated) - Extend to track modifications
- `docs/api-specs/cursor/cursor-api.md` (updated) - API specification

