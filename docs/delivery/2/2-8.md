# 2-8 Handle conversation updates and modifications

[Back to task list](./tasks.md)

## Description

Handle updates to existing conversations that are modified after initial capture. Cursor may update conversation logs as users continue chatting, and we need to detect these updates and update our exported markdown files accordingly.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-11-14 22:41:32 | Created | N/A | Proposed | Task file created | System |

## Requirements

1. Detect when `{cursor.log_path}/globalStorage/state.vscdb` database file is modified
2. Query database to identify which composer IDs were updated
3. Parse updated conversation content from database
4. Identify new messages added to existing conversation (compare `fullConversationHeadersOnly` array length)
5. Update existing markdown file with new messages
6. Preserve existing content while appending new content
7. Handle cases where conversation structure changes
8. Track which composer IDs and message counts have been processed to avoid duplicates
9. Handle concurrent updates gracefully

## Implementation Plan

1. Extend watcher service (from task 2-3):
   - Track which composer IDs have been processed
   - Detect modification events for `state.vscdb` database file
   - Query database to identify which composer IDs were updated
2. Implement update detection:
   - Location: `internal/cursor/updater.go`
   - Package: `cursor`
3. Track processed conversations:
   - Maintain state of processed composer IDs (composer ID + message count)
   - Persist state to disk (JSON file or database)
   - Load state on startup
4. Implement incremental parsing:
   - Use parser from task 2-4 with incremental support
   - Query database for updated composer data
   - Compare `fullConversationHeadersOnly` array length to detect new messages
   - Only parse new messages since last update
   - Merge new messages with existing conversation
5. Implement markdown update logic:
   - Read existing markdown file
   - Append new messages to end
   - Update session metadata (message count, end time, duration)
   - Preserve existing formatting
6. Handle database updates:
   ```go
   type ConversationUpdater interface {
       ProcessUpdate(composerID string) error
       HasBeenProcessed(composerID string, messageCount int) bool
       MarkAsProcessed(composerID string, messageCount int) error
       DetectUpdatedComposers() ([]string, error) // Query database for updated composer IDs
   }
   ```
7. Implement atomic updates:
   - Write updated content to temporary file
   - Replace original file atomically
   - Handle errors gracefully
8. Handle edge cases:
   - Conversation file deleted
   - Conversation file corrupted
   - Concurrent modifications
   - Large conversation updates
9. Write unit tests for update handling

## Test Plan

**Objective**: Verify conversation updates are detected and markdown files are updated correctly.

**Test Scope**:
- Update detection
- Incremental parsing
- Markdown file updates
- State tracking
- Concurrent updates

**Environment & Setup**:
- Use temporary directories and files for testing
- Simulate file modifications
- Test with sample conversations

**Key Test Scenarios**:
1. Detect modification to database file
2. Query database to identify updated composer IDs
3. Compare message counts to detect new messages
4. Parse only new messages from update
5. Append new messages to existing markdown file
6. Update session metadata correctly
7. Preserve existing markdown formatting
8. Track processed composer IDs correctly
9. Handle composer ID that was already processed (same message count)
10. Handle concurrent updates gracefully
11. Handle database locking gracefully
12. Handle corrupted database entries gracefully

**Success Criteria**:
- Updates detected correctly
- New messages appended correctly
- Existing content preserved
- State tracking works correctly
- Atomic updates work correctly

## Verification

- [ ] Update detection implemented
- [ ] Processed file tracking implemented
- [ ] Incremental parsing works
- [ ] Markdown update logic implemented
- [ ] New messages appended correctly
- [ ] Session metadata updated correctly
- [ ] Atomic file updates implemented
- [ ] Edge cases handled
- [ ] Unit tests written and passing
- [ ] State persistence works

## Files Modified

- `internal/cursor/updater.go` (new) - Conversation update handling
- `internal/cursor/updater_test.go` (new) - Unit tests for updater
- `internal/cursor/watcher.go` (updated) - Extend to track modifications
- `docs/api-specs/cursor/cursor-api.md` (updated) - API specification

