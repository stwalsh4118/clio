# 2-10 Integrate Cursor capture components into daemon

[Back to task list](./tasks.md)

## Description

Integrate all Cursor conversation capture components (watcher, parser, project detector, session tracker, storage) into the main daemon process. This task wires together the complete pipeline so that file system events trigger the full conversation capture and database storage workflow.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-27 00:00:00 | Created | N/A | Proposed | Integration task created | System |

## Requirements

1. Integrate watcher service into daemon startup
2. Wire file system events to parser
3. Integrate project detector to map conversations to projects
4. Integrate session tracker to group conversations
5. Integrate database storage to persist conversations
6. Handle the complete pipeline: watcher → parser → project detector → session tracker → database storage
7. Start all services when daemon starts
8. Stop all services gracefully on daemon shutdown
9. Handle errors in pipeline without crashing daemon
10. Process events asynchronously without blocking

## Implementation Plan

1. Update daemon structure:
   - File: `internal/daemon/daemon.go`
   - Add fields for cursor capture services
   - Store config reference
2. Create cursor capture service:
   - Location: `internal/cursor/capture.go`
   - Package: `cursor`
   - Service that orchestrates all components
3. Implement capture service interface:
   ```go
   type CaptureService interface {
       Start() error
       Stop() error
       ProcessEvent(event FileEvent) error
   }
   ```
4. Implement capture service:
   - Initialize watcher, parser, project detector, session tracker, storage
   - Start watcher and begin processing events
   - Handle event pipeline:
     - On file event: parse conversations
     - Detect project for each conversation
     - Add to appropriate session
     - Store session and conversations in database
   - Handle errors gracefully (log and continue)
5. Integrate into daemon:
   - Update `NewDaemon()` to accept config
   - Create capture service instance
   - Start capture service in `Run()`
   - Stop capture service in `Shutdown()`
6. Handle graceful shutdown:
   - Stop watcher
   - Close parser database connections
   - Flush pending database writes
   - Wait for in-flight operations to complete
7. Add error handling:
   - Log errors but continue operation
   - Don't crash daemon on individual failures
   - Retry failed operations where appropriate
8. Process events asynchronously:
   - Use goroutines for event processing
   - Use channels for event coordination
   - Prevent blocking the main daemon loop

## Test Plan

**Objective**: Verify integration of all components works correctly in daemon context.

**Test Scope**:
- Daemon startup with capture service
- Event processing pipeline
- Graceful shutdown
- Error handling
- Concurrent event processing

**Environment & Setup**:
- Unit tests with mocked components
- Integration tests with test database
- Test daemon lifecycle (start/stop)

**Key Test Scenarios**:
1. Daemon starts capture service successfully
2. File events trigger full pipeline
3. Conversations parsed and added to sessions
4. Sessions and conversations stored in database
5. Multiple events processed concurrently
6. Errors in pipeline don't crash daemon
7. Graceful shutdown stops all services
8. Pending database operations complete on shutdown
9. Daemon handles missing components gracefully
10. Daemon handles config errors gracefully

**Success Criteria**:
- All components integrated correctly
- Event pipeline works end-to-end
- Daemon operates stably
- Graceful shutdown works
- Errors handled without crashes

## Verification

- [ ] Capture service implemented
- [ ] Daemon integrates capture service
- [ ] Watcher started on daemon startup
- [ ] Events processed through full pipeline
- [ ] Project detection integrated
- [ ] Session tracking integrated
- [ ] Database storage integrated
- [ ] Graceful shutdown implemented
- [ ] Error handling prevents crashes
- [ ] Events processed asynchronously
- [ ] Integration tests passing

## Files Modified

- `internal/daemon/daemon.go` (updated) - Integrate capture service
- `internal/cursor/capture.go` (new) - Capture service orchestration
- `internal/cursor/capture_test.go` (new) - Unit tests for capture service
- `internal/cli/daemon.go` (updated) - Pass config to daemon
- `docs/api-specs/cursor/cursor-api.md` (updated) - Document capture service API
