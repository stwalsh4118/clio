# 2-7 Implement project detection mechanism

[Back to task list](./tasks.md)

## Description

Implement a mechanism to detect which project a conversation belongs to. This is critical for organizing conversations into the correct project subdirectories and grouping them into sessions.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-11-14 22:41:32 | Created | N/A | Proposed | Task file created | System |

## Requirements

1. Detect project name from conversation content or metadata
2. Support multiple detection strategies (fallback chain)
3. Handle cases where project cannot be determined
4. Use project name for directory organization
5. Use project name for session grouping
6. Normalize project names (handle special characters, paths, etc.)

## Implementation Plan

1. Design project detection service:
   - Location: `internal/cursor/project.go`
   - Package: `cursor`
2. Define detection strategies (in priority order):
   - Strategy 1: Query workspace databases to find composer ID → workspace association
     - Scan `{cursor.log_path}/workspaceStorage/{workspace-hash}/` directories
     - Read `workspace.json` to map workspace hash → project path
     - Query workspace `state.vscdb` for composer IDs
     - Map composer ID → workspace → project path
   - Strategy 2: Parse from conversation content (file paths, project references)
   - Strategy 3: Use configured project mapping (if user configures)
   - Strategy 4: Default to "unknown" or "default" project
3. Implement project detector interface:
   ```go
   type ProjectDetector interface {
       DetectProject(conv Conversation) (string, error)
       NormalizeProjectName(name string) string
   }
   ```
4. Implement workspace association lookup:
   - Get cursor log path from config: `config.Cursor.LogPath`
   - Scan `{log_path}/workspaceStorage/` directory for workspace hash directories
   - For each workspace:
     - Read `{log_path}/workspaceStorage/{hash}/workspace.json` to get project path
     - Query `{log_path}/workspaceStorage/{hash}/state.vscdb` for composer IDs
     - Build mapping: composer ID → workspace hash → project path
   - Use this mapping to detect project for a given composer ID
5. Implement content-based detection:
   - Parse file paths mentioned in conversation
   - Extract project name from common patterns (git repo names, directory names)
   - Look for project references in messages
6. Implement workspace scanning:
   - Periodically scan workspaceStorage directory for new workspaces
   - Cache workspace hash → project path mapping
   - Update mapping when new workspaces are detected
7. Implement project name normalization:
   - Remove special characters that aren't filesystem-safe
   - Convert to lowercase or consistent case
   - Handle path separators
   - Limit length if needed
8. Handle unknown projects:
   - Use "unknown" or "default" as fallback
   - Allow user to configure project mapping later
9. Write unit tests for detection strategies

## Test Plan

**Objective**: Verify project detection correctly identifies project from various sources.

**Test Scope**:
- Metadata extraction
- Content-based detection
- Project name normalization
- Fallback handling

**Environment & Setup**:
- Unit tests with sample conversations
- Test with various project name formats

**Key Test Scenarios**:
1. Scan workspaceStorage directory correctly
2. Read workspace.json files correctly
3. Query workspace databases for composer IDs correctly
4. Map composer ID to project path correctly
5. Detect project from workspace association (Strategy 1)
6. Detect project from file paths in conversation (Strategy 2)
7. Detect project from git repository references (Strategy 2)
8. Normalize project names correctly
9. Handle special characters in project names
10. Fallback to "unknown" when project cannot be determined
11. Handle multiple detection strategies (try each in order)
12. Handle missing workspace.json files gracefully

**Success Criteria**:
- Project detected from available sources
- Project names normalized correctly
- Fallback works when detection fails
- Detection strategies work in priority order

## Verification

- [ ] Project detector interface designed
- [ ] Workspace association lookup implemented
- [ ] Workspace scanning implemented
- [ ] Content-based detection implemented
- [ ] Workspace hash → project path mapping built correctly
- [ ] Project name normalization implemented
- [ ] Fallback handling implemented
- [ ] Unit tests written and passing
- [ ] Detection works with sample conversations

## Files Modified

- `internal/cursor/project.go` (new) - Project detection implementation
- `internal/cursor/project_test.go` (new) - Unit tests for project detection
- `docs/api-specs/cursor/cursor-api.md` (updated) - API specification

