# 2-4 Design and implement conversation parser

[Back to task list](./tasks.md)

## Description

Design and implement a parser to extract messages, identify user vs agent responses, and extract metadata from Cursor log files. This parser will convert Cursor's internal log format into structured data that can be used for markdown export and session tracking.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-11-14 22:41:32 | Created | N/A | Proposed | Task file created | System |

## Requirements

1. Parse Cursor log file format (determined in task 2-1)
2. Extract individual messages from log files
3. Identify user messages vs agent responses
4. Extract metadata: timestamps, session IDs, project context
5. Handle malformed or corrupted log files gracefully
6. Support incremental parsing (for conversation updates)
7. Return structured data suitable for markdown export
8. Handle edge cases (empty files, missing fields, etc.)

## Implementation Plan

1. Design parser interface:
   - Location: `internal/cursor/parser.go`
   - Package: `cursor`
2. Define data structures:
   ```go
   type Conversation struct {
       SessionID    string
       Project      string
       StartTime    time.Time
       EndTime      time.Time
       Messages     []Message
   }
   
   type Message struct {
       Timestamp   time.Time
       Role        string // "user" or "agent"
       Content     string
       Metadata    map[string]interface{}
   }
   ```
3. Implement parser based on format from research:
   - If JSON: use `encoding/json`
   - If SQLite: use `database/sql` with SQLite driver
   - If other: implement custom parser
4. Implement message extraction:
   - Parse log file structure
   - Extract message array/list
   - Convert to internal Message structs
5. Implement role identification:
   - Determine user vs agent based on log structure
   - Handle different message types if applicable
6. Extract metadata:
   - Parse timestamps
   - Extract session ID if available
   - Extract project context if available
   - Extract any other relevant metadata
7. Handle errors:
   - Return parsing errors for malformed files
   - Log warnings for missing optional fields
   - Continue parsing if possible despite errors
8. Support incremental parsing:
   - Track what has been parsed before
   - Only parse new/updated sections
9. Write comprehensive unit tests:
   - Test with sample log files
   - Test error cases
   - Test edge cases

## Test Plan

**Objective**: Verify conversation parser correctly extracts messages and metadata from Cursor log files.

**Test Scope**:
- Log file parsing
- Message extraction
- Role identification
- Metadata extraction
- Error handling

**Environment & Setup**:
- Use sample log files from research (task 2-1)
- Create test fixtures with known structure
- Test with various log file formats

**Key Test Scenarios**:
1. Parse valid log file successfully
2. Extract all messages correctly
3. Identify user messages correctly
4. Identify agent responses correctly
5. Extract timestamps correctly
6. Extract session ID if available
7. Extract project context if available
8. Handle malformed log files gracefully
9. Handle missing optional fields
10. Support incremental parsing for updates

**Success Criteria**:
- All messages extracted correctly
- User vs agent identification accurate
- Metadata extracted correctly
- Error handling works for malformed files
- Parser handles edge cases gracefully

## Verification

- [ ] Parser interface designed
- [ ] Data structures defined
- [ ] Log file parsing implemented
- [ ] Message extraction implemented
- [ ] Role identification implemented
- [ ] Metadata extraction implemented
- [ ] Error handling implemented
- [ ] Incremental parsing supported
- [ ] Unit tests written and passing
- [ ] Parser handles edge cases

## Files Modified

- `internal/cursor/parser.go` (new) - Conversation parser implementation
- `internal/cursor/types.go` (new) - Data structures for conversations and messages
- `internal/cursor/parser_test.go` (new) - Unit tests for parser
- `docs/api-specs/cursor/cursor-api.md` (updated) - API specification

