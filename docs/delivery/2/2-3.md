# 2-3 Implement file system watcher for Cursor log directory

[Back to task list](./tasks.md)

## Description

Implement a file system watcher using fsnotify to monitor the Cursor log directory for new and modified files. This component will detect when Cursor creates or updates conversation log files and trigger processing.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-11-14 22:41:32 | Created | N/A | Proposed | Task file created | System |

## Requirements

1. Watch Cursor log directory for file system events
2. Detect new conversation files being created
3. Detect modifications to existing conversation files
4. Handle file system events without blocking
5. Filter events to only process relevant files (conversation logs)
6. Handle multiple concurrent events
7. Gracefully handle watcher errors and continue monitoring
8. Support starting and stopping the watcher
9. Integrate with discovery service from task 2-2

## Implementation Plan

1. Add fsnotify dependency:
   - `go get github.com/fsnotify/fsnotify`
   - Add to `go.mod`
2. Create watcher service:
   - Location: `internal/cursor/watcher.go`
   - Package: `cursor`
3. Implement watcher interface:
   ```go
   type WatcherService interface {
       Start() error
       Stop() error
       Watch() (<-chan FileEvent, error)
   }
   ```
4. Set up fsnotify watcher:
   - Create watcher instance
   - Add watch for Cursor log directory
   - Handle CREATE and WRITE events
5. Filter events:
   - Only process files matching conversation log patterns
   - Ignore temporary files, directories, etc.
6. Convert fsnotify events to internal FileEvent type:
   - Include file path, event type, timestamp
7. Implement event channel:
   - Non-blocking channel for file events
   - Buffer events appropriately
8. Handle errors:
   - Log watcher errors
   - Attempt to re-establish watch if it fails
   - Don't crash on individual file errors
9. Add graceful shutdown:
   - Stop watching on Stop() call
   - Close channels properly
10. Write unit tests with mocked file system

## Test Plan

**Objective**: Verify file system watcher correctly detects new and modified files in Cursor log directory.

**Test Scope**:
- File system event detection
- Event filtering
- Event channel delivery
- Error handling
- Start/stop functionality

**Environment & Setup**:
- Use temporary directories for testing
- Mock or use test file system events
- Test with fsnotify test utilities if available

**Key Test Scenarios**:
1. Watcher detects new file creation
2. Watcher detects file modification
3. Watcher filters out irrelevant files
4. Multiple concurrent events are handled
5. Watcher continues after individual file errors
6. Watcher can be started and stopped
7. Events are delivered through channel correctly
8. Watcher handles directory not found gracefully

**Success Criteria**:
- New files detected correctly
- Modified files detected correctly
- Events filtered appropriately
- Non-blocking operation verified
- Error handling works correctly
- Watcher can be controlled (start/stop)

## Verification

- [ ] fsnotify dependency added
- [ ] Watcher service implemented
- [ ] New file events detected
- [ ] File modification events detected
- [ ] Event filtering implemented
- [ ] Event channel implemented
- [ ] Error handling implemented
- [ ] Start/stop functionality works
- [ ] Unit tests written and passing
- [ ] Integration with discovery service works

## Files Modified

- `go.mod` (updated with fsnotify dependency)
- `go.sum` (updated)
- `internal/cursor/watcher.go` (new) - File system watcher service
- `internal/cursor/watcher_test.go` (new) - Unit tests for watcher
- `docs/api-specs/cursor/cursor-api.md` (updated) - API specification

