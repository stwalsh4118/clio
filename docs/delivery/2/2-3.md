# 2-3 Implement file system watcher for Cursor log directory

[Back to task list](./tasks.md)

Implement a file system watcher using fsnotify to monitor the Cursor global storage database file for modifications. This component will detect when Cursor updates the `state.vscdb` database file (which happens when conversations are created or updated) and trigger processing.

**Path**: The watcher monitors `{cursor.log_path}/globalStorage/state.vscdb` where `cursor.log_path` is the configured Cursor User directory (e.g., `~/.config/Cursor/User/`).

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-11-14 22:41:32 | Created | N/A | Proposed | Task file created | System |
| 2025-01-27 00:00:00 | Status Change | Proposed | Agreed | Task approved | User |
| 2025-01-27 00:00:00 | Status Change | Agreed | InProgress | Started implementation | AI Agent |
| 2025-01-27 00:00:00 | Status Change | InProgress | Review | Implementation complete, all tests passing | AI Agent |
| 2025-01-27 00:00:00 | Status Change | Review | Done | Task completed and verified | User |

## Requirements

1. Watch `{cursor.log_path}/globalStorage/state.vscdb` file for modifications
2. Detect when the database file is modified (indicates new or updated conversations)
3. Handle file system events without blocking
4. Handle multiple concurrent events
5. Gracefully handle watcher errors and continue monitoring
6. Support starting and stopping the watcher
7. Get cursor log path from config: `config.Cursor.LogPath`
8. Construct full path: `filepath.Join(cfg.Cursor.LogPath, "globalStorage", "state.vscdb")`

## Implementation Plan

1. Add fsnotify dependency:
   - `go get github.com/fsnotify/fsnotify`
   - Add to `go.mod`
2. Create watcher service:
   - Location: `internal/cursor/watcher.go`
   - Package: `cursor`
3. Implement watcher interface:
   ```go
   type WatcherService interface {
       Start() error
       Stop() error
       Watch() (<-chan FileEvent, error)
   }
   ```
4. Set up fsnotify watcher:
   - Create watcher instance
   - Get cursor log path from config: `config.Cursor.LogPath`
   - Construct database file path: `{log_path}/globalStorage/state.vscdb`
   - Add watch for the database file
   - Handle WRITE events (file modifications)
5. Filter events:
   - Only process events for `state.vscdb` file
   - Ignore events for other files or directories
6. Convert fsnotify events to internal FileEvent type:
   - Include file path, event type, timestamp
7. Implement event channel:
   - Non-blocking channel for file events
   - Buffer events appropriately
8. Handle errors:
   - Log watcher errors
   - Attempt to re-establish watch if it fails
   - Don't crash on individual file errors
9. Add graceful shutdown:
   - Stop watching on Stop() call
   - Close channels properly
10. Write unit tests with mocked file system

## Test Plan

**Objective**: Verify file system watcher correctly detects new and modified files in Cursor log directory.

**Test Scope**:
- File system event detection
- Event filtering
- Event channel delivery
- Error handling
- Start/stop functionality

**Environment & Setup**:
- Use temporary directories for testing
- Mock or use test file system events
- Test with fsnotify test utilities if available

**Key Test Scenarios**:
1. Watcher detects new file creation
2. Watcher detects file modification
3. Watcher filters out irrelevant files
4. Multiple concurrent events are handled
5. Watcher continues after individual file errors
6. Watcher can be started and stopped
7. Events are delivered through channel correctly
8. Watcher handles database file not found gracefully
9. Watcher constructs correct path from config

**Success Criteria**:
- New files detected correctly
- Modified files detected correctly
- Events filtered appropriately
- Non-blocking operation verified
- Error handling works correctly
- Watcher can be controlled (start/stop)

## Verification

- [ ] fsnotify dependency added
- [ ] Watcher service implemented
- [ ] New file events detected
- [ ] File modification events detected
- [ ] Event filtering implemented
- [ ] Event channel implemented
- [ ] Error handling implemented
- [ ] Start/stop functionality works
- [ ] Unit tests written and passing
- [ ] Path constructed correctly from config
- [ ] Watches correct database file path

## Files Modified

- `go.mod` (updated with fsnotify dependency)
- `go.sum` (updated)
- `internal/cursor/watcher.go` (new) - File system watcher service
- `internal/cursor/watcher_test.go` (new) - Unit tests for watcher
- `docs/api-specs/cursor/cursor-api.md` (updated) - API specification

