# 3-4 Implement commit metadata extraction

[Back to task list](./tasks.md)

## Description

Implement functionality to extract commit metadata from git commits, including hash, message, timestamp, author, and branch information. Handle edge cases such as detached HEAD state and provide structured data for downstream processing.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-11-16 00:55:17 | Created | N/A | Proposed | Task file created | System |
| 2025-11-16 16:30:00 | Status Update | Proposed | InProgress | Started implementation | AI Agent |
| 2025-11-16 17:00:00 | Status Update | InProgress | Review | Implementation complete, all tests passing | AI Agent |
| 2025-11-16 17:15:00 | Status Update | Review | Done | Task completed and verified | User |

## Requirements

1. Extract commit hash (full SHA)
2. Extract commit message (full message, including multi-line)
3. Extract commit timestamp (author time)
4. Extract author information (name and email)
5. Extract branch name (or "detached" if in detached HEAD state)
6. Handle edge cases:
   - Detached HEAD state
   - Merge commits
   - Commits with no parent (initial commit)
   - Commits with multiple parents (merge commits)
7. Store metadata in structured format
8. Integrate with go-git library from task 3-1

## Implementation Plan

1. Create commit metadata extraction service:
   - Location: `internal/git/extractor.go`
   - Package: `git`
2. Define commit metadata structure:
   ```go
   type CommitMetadata struct {
       Hash      string
       Message   string
       Timestamp time.Time
       Author    AuthorInfo
       Branch    string
       IsMerge   bool
       ParentHashes []string
   }
   
   type AuthorInfo struct {
       Name  string
       Email string
   }
   ```
3. Implement extraction interface:
   ```go
   type ExtractorService interface {
       ExtractMetadata(repo Repository, commitHash string) (*CommitMetadata, error)
       ExtractMetadataBatch(repo Repository, commitHashes []string) ([]CommitMetadata, error)
   }
   ```
4. Implement metadata extraction:
   - Open repository using go-git
   - Resolve commit object from hash
   - Extract hash (commit.Hash().String())
   - Extract message (commit.Message)
   - Extract timestamp (commit.Author.When)
   - Extract author (commit.Author.Name, commit.Author.Email)
   - Determine branch name:
     - Try to find branch containing commit
     - If not found, check if HEAD is detached
     - Use "detached" as branch name if detached
   - Detect merge commits (len(commit.ParentHashes) > 1)
   - Extract parent hashes
5. Handle edge cases:
   - Detached HEAD: Check HEAD reference, use "detached" if not on branch
   - Merge commits: Detect and mark appropriately
   - Initial commits: Handle commits with no parents
6. Batch extraction for efficiency:
   - Extract metadata for multiple commits in single repository open
   - Reuse repository object
7. Write unit tests with test repositories

## Test Plan

**Objective**: Verify commit metadata extraction correctly extracts all required fields from git commits.

**Test Scope**:
- Metadata extraction
- Edge case handling
- Batch extraction
- Branch detection

**Environment & Setup**:
- Use temporary git repositories for testing
- Create commits with various characteristics
- Test with detached HEAD state
- Test with merge commits

**Key Test Scenarios**:
1. Extract metadata from normal commit
2. Extract metadata from merge commit
3. Extract metadata from initial commit
4. Extract branch name correctly
5. Handle detached HEAD state
6. Extract multi-line commit messages
7. Extract author information correctly
8. Extract timestamp correctly
9. Batch extraction works efficiently
10. Handle invalid commit hash gracefully

**Success Criteria**:
- All metadata fields extracted correctly
- Branch name detected accurately
- Detached HEAD handled correctly
- Merge commits detected
- Batch extraction works
- Error handling works correctly

## Verification

- [x] Commit metadata structure defined
- [x] Extraction service implemented
- [x] Hash extracted correctly
- [x] Message extracted correctly
- [x] Timestamp extracted correctly
- [x] Author information extracted correctly
- [x] Branch name extracted correctly
- [x] Detached HEAD handled
- [x] Merge commits detected
- [x] Unit tests written and passing

## Files Modified

- `internal/git/extractor.go` (new) - Commit metadata extraction service
- `internal/git/types.go` (new) - Git-related types and structures
- `internal/git/extractor_test.go` (new) - Unit tests for extractor
- `docs/api-specs/git/git-api.md` (updated) - API specification

