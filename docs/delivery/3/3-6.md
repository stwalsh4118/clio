# 3-6 Implement commit-to-session correlation

[Back to task list](./tasks.md)

## Description

Implement functionality to correlate git commits with Cursor conversation timestamps and group commits by development session. This enables linking code changes with the conversations that led to them.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-11-16 00:55:17 | Created | N/A | Proposed | Task file created | System |
| 2025-11-16 06:30:00 | Status Update | Proposed | Done | Correlation service implemented with commit-to-session matching, project normalization, and grouping functionality | System |

## Requirements

1. Correlate commits with conversation timestamps
2. Use 5-minute window for correlation precision (from research task 3-1)
3. Group commits by development session
4. Identify commits that occurred during active Cursor conversations
5. Match commits to sessions based on:
   - Timestamp proximity (within 5 minutes)
   - Project/repository matching
6. Handle commits outside active sessions
7. Integrate with session management from PBI 2
8. Store correlation data for markdown export

## Implementation Plan

1. Create correlation service:
   - Location: `internal/git/correlation.go`
   - Package: `git`
2. Define correlation structures:
   ```go
   type CommitSessionCorrelation struct {
       CommitHash  string
       SessionID   string
       Project     string
       CorrelationType string // "active", "proximate", "none"
       TimeDiff    time.Duration
   }
   ```
3. Implement correlation interface:
   ```go
   type CorrelationService interface {
       CorrelateCommit(commit CommitMetadata, sessions []Session) (*CommitSessionCorrelation, error)
       CorrelateCommits(commits []CommitMetadata, sessions []Session) ([]CommitSessionCorrelation, error)
   }
   ```
4. Implement correlation logic:
   - Get active sessions from session manager (PBI 2)
   - For each commit:
     - Find sessions with matching project/repository
     - Check if commit timestamp falls within session time window
     - Check if commit timestamp is within 5 minutes of any conversation message
     - Determine correlation type:
       - "active": Commit during active session with conversation activity
       - "proximate": Commit within 5 minutes of conversation but not during active session
       - "none": No correlation found
   - Calculate time difference to nearest conversation
5. Group commits by session:
   - Group correlated commits by session ID
   - Include commits with "proximate" correlation
   - Handle commits with no correlation (group by date/project)
6. Integration points:
   - Use session manager from `internal/cursor/session.go`
   - Access session data structure
   - Match repository path to project name
7. Handle edge cases:
   - Commits before any sessions
   - Commits after all sessions
   - Multiple sessions overlapping in time
   - Commits in repositories not matching any project
8. Write unit tests with mock sessions

## Test Plan

**Objective**: Verify commit-to-session correlation correctly matches commits with conversations based on timestamps and project matching.

**Test Scope**:
- Timestamp correlation
- Project matching
- Session grouping
- Edge case handling

**Environment & Setup**:
- Use mock sessions for testing
- Create commits with various timestamps
- Test with overlapping sessions
- Test with sessions in different projects

**Key Test Scenarios**:
1. Correlate commit during active session
2. Correlate commit within 5 minutes of conversation
3. Correlate commit outside 5-minute window
4. Match commits to correct project/session
5. Handle commits with no matching session
6. Group commits by session correctly
7. Handle overlapping sessions
8. Handle commits before/after sessions
9. Handle commits in different repositories
10. Calculate time differences correctly

**Success Criteria**:
- Commits correlated correctly with sessions
- 5-minute window respected
- Project matching works correctly
- Commits grouped by session
- Edge cases handled gracefully
- Error handling works correctly

## Verification

- [ ] Correlation service implemented
- [ ] Timestamp correlation works (5-minute window)
- [ ] Project matching works
- [ ] Commits grouped by session
- [ ] Active session detection works
- [ ] Proximate correlation works
- [ ] Edge cases handled
- [ ] Integration with session manager works
- [ ] Unit tests written and passing

## Files Modified

- `internal/git/correlation.go` (new) - Commit-to-session correlation service
- `internal/git/types.go` (updated) - Add correlation types
- `internal/git/correlation_test.go` (new) - Unit tests for correlation
- `docs/api-specs/git/git-api.md` (updated) - API specification

