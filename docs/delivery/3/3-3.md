# 3-3 Implement git commit polling mechanism

[Back to task list](./tasks.md)

## Description

Implement a periodic polling mechanism to monitor git repositories for new commits. The poller will check each discovered repository at configurable intervals, detect new commits by comparing with previously seen commits, and handle multiple repositories concurrently.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-11-16 00:55:17 | Created | N/A | Proposed | Task file created | System |
| 2025-11-16 14:00:00 | Status Update | Proposed | InProgress | Started implementation | AI Agent |
| 2025-11-16 15:30:00 | Status Update | InProgress | Review | Implementation complete, all tests passing | AI Agent |
| 2025-11-16 16:00:00 | Status Update | Review | Done | Task completed and verified | User |

## Requirements

1. Implement periodic polling of git repositories
2. Use configurable polling interval (default: 30 seconds, from config or separate git config)
3. Detect new commits by comparing current HEAD commit hash with last seen commit hash
4. Store last seen commit hash per repository (in-memory initially, can be persisted later)
5. Handle multiple repositories concurrently
6. Support starting and stopping the poller
7. Emit events when new commits are detected
8. Get polling interval from config (add `Git.PollIntervalSeconds` to config if needed)
9. Integrate with repository discovery service from task 3-2

## Implementation Plan

1. Add git polling configuration:
   - Add `Git.PollIntervalSeconds` to `config.Config` struct (default: 30)
   - Update config loader and defaults
2. Create polling service:
   - Location: `internal/git/poller.go`
   - Package: `git`
3. Define poller interface:
   ```go
   type PollerService interface {
       Start(ctx context.Context, repos []Repository) error
       Stop() error
       PollResults() <-chan PollResult
   }
   
   type PollResult struct {
       Repository Repository
       NewCommits []CommitHash
       Error      error
   }
   ```
4. Implement polling logic:
   - Use ticker for periodic polling (from config interval)
   - For each repository:
     - Open repository using go-git
     - Get current HEAD commit hash
     - Compare with stored last seen hash
     - If different, collect all commits between last seen and HEAD
     - Update last seen hash
     - Emit poll result with new commits
5. Handle concurrent polling:
   - Poll repositories in parallel using goroutines
   - Use sync primitives to manage state
   - Handle repository errors without stopping entire poller
6. Implement state management:
   - Store last seen commit hash per repository (map[string]string)
   - Thread-safe access to state
   - Initialize state on start
7. Handle lifecycle:
   - Start polling on Start() call
   - Stop polling and cleanup on Stop() call
   - Graceful shutdown on context cancellation
8. Write unit tests with mocked repositories

## Test Plan

**Objective**: Verify git commit polling correctly detects new commits in monitored repositories.

**Test Scope**:
- Periodic polling execution
- Commit detection
- State management
- Concurrent repository handling
- Error handling

**Environment & Setup**:
- Use temporary git repositories for testing
- Create commits programmatically
- Mock time for testing intervals

**Key Test Scenarios**:
1. Poller detects new commits in single repository
2. Poller detects new commits in multiple repositories
3. Poller handles repositories with no new commits
4. Poller correctly tracks last seen commit hash
5. Poller handles concurrent polling of multiple repositories
6. Poller continues after individual repository errors
7. Poller can be started and stopped
8. Polling interval is configurable
9. Poller emits events for new commits
10. Poller handles repositories that are removed

**Success Criteria**:
- New commits detected correctly
- Last seen hash tracked accurately
- Multiple repositories polled concurrently
- Error handling works correctly
- Poller can be controlled (start/stop)
- Polling interval respected

## Verification

- [x] Polling configuration added to config
- [x] Poller service implemented
- [x] Periodic polling works correctly
- [x] New commits detected
- [x] Last seen hash tracked
- [x] Multiple repositories handled concurrently
- [x] Error handling implemented
- [x] Start/stop functionality works
- [x] Polling interval configurable
- [x] Unit tests written and passing

## Files Modified

- `internal/config/config.go` (updated) - Add Git.PollIntervalSeconds configuration
- `internal/git/poller.go` (new) - Git commit polling service
- `internal/git/poller_test.go` (new) - Unit tests for poller
- `docs/api-specs/git/git-api.md` (updated) - API specification

