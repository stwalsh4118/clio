# 3-10 E2E CoS Test

[Back to task list](./tasks.md)

## Description

Create comprehensive end-to-end tests that verify all 11 acceptance criteria from PBI 3 are met. These tests will validate the complete git capture workflow from repository discovery through commit export, ensuring the system works correctly in realistic scenarios.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-11-16 00:55:17 | Created | N/A | Proposed | Task file created | System |

## Requirements

1. Test all 11 acceptance criteria from PBI 3:
   1. System successfully discovers git repositories in configured watched directories
   2. Git commit monitor detects new commits in watched repositories
   3. System extracts commit metadata: hash, message, timestamp, author, branch
   4. System extracts full commit diffs
   5. Commits are exported to markdown files in correct directory structure
   6. Commit markdown files are human-readable and well-formatted
   7. Commits are correlated with conversation timestamps
   8. System handles multiple repositories concurrently
   9. System continues operating stably for 8+ hour sessions
   10. Large commits (>1000 lines changed) are handled efficiently
   11. System gracefully handles git repository errors (corrupted repos, etc.)
2. Test with realistic scenarios:
   - Multiple repositories
   - Multiple commits per repository
   - Commits during active sessions
   - Commits outside sessions
   - Large commits
   - Error scenarios
3. Test integration with Cursor capture system
4. Verify markdown file format matches PRD specification
5. Test long-running stability (simulated 8+ hour session)

## Implementation Plan

1. Create E2E test file:
   - Location: `test/e2e/pbi3_cos_test.go`
   - Package: `e2e`
2. Set up test infrastructure:
   - Use test helpers from `test/e2e/helpers.go`
   - Create temporary directories for test repositories
   - Create temporary git repositories
   - Set up test configuration
   - Create test daemon instance
3. Test CoS 1: Repository Discovery
   - Create multiple git repositories in watched directories
   - Start daemon
   - Verify repositories are discovered
   - Verify repository metadata is correct
4. Test CoS 2: Commit Detection
   - Create commits in test repositories
   - Wait for polling interval
   - Verify commits are detected
   - Verify new commits are identified correctly
5. Test CoS 3: Metadata Extraction
   - Create commits with various characteristics
   - Verify hash extracted correctly
   - Verify message extracted correctly
   - Verify timestamp extracted correctly
   - Verify author extracted correctly
   - Verify branch extracted correctly
6. Test CoS 4: Diff Extraction
   - Create commits with various diff sizes
   - Verify full diff extracted
   - Verify file-level statistics extracted
   - Verify diff format is correct
7. Test CoS 5: Markdown Export Directory Structure
   - Create commits
   - Verify markdown files created in correct location
   - Verify directory structure: `~/.clio/sessions/YYYY-MM-DD/<project>/commits.md`
   - Verify multiple commits append to same file
8. Test CoS 6: Markdown Format
   - Verify markdown files are readable
   - Verify format matches PRD specification
   - Verify all required sections present
   - Verify formatting is correct
9. Test CoS 7: Commit Correlation
   - Create Cursor conversation sessions
   - Create commits during sessions
   - Create commits outside sessions
   - Verify commits correlated correctly
   - Verify 5-minute window respected
10. Test CoS 8: Multiple Repositories
    - Create multiple repositories
    - Create commits in each
    - Verify all repositories monitored concurrently
    - Verify commits from all repositories captured
11. Test CoS 9: Long-Running Stability
    - Run daemon for extended period (simulated)
    - Create commits periodically
    - Verify system continues operating
    - Verify no memory leaks or resource issues
    - Verify commits continue to be captured
12. Test CoS 10: Large Commits
    - Create commits with >1000 lines changed
    - Verify large commits handled efficiently
    - Verify diffs truncated appropriately (>5000 lines)
    - Verify file statistics still extracted
13. Test CoS 11: Error Handling
    - Create corrupted repository
    - Create repository with permission errors
    - Remove repository during operation
    - Verify errors handled gracefully
    - Verify system continues operating
    - Verify errors logged appropriately
14. Clean up test resources

## Test Plan

**Objective**: Verify all 11 acceptance criteria from PBI 3 are met through comprehensive end-to-end testing.

**Test Scope**:
- All 11 acceptance criteria
- Complete workflow validation
- Integration testing
- Error scenario testing
- Long-running stability

**Environment & Setup**:
- Use test helpers for daemon setup
- Create temporary git repositories
- Create temporary Cursor sessions (if needed)
- Use test configuration
- Clean up after tests

**Key Test Scenarios**:
1. **CoS 1**: Repository discovery in watched directories
2. **CoS 2**: Commit detection in monitored repositories
3. **CoS 3**: Metadata extraction (hash, message, timestamp, author, branch)
4. **CoS 4**: Full commit diff extraction
5. **CoS 5**: Markdown export to correct directory structure
6. **CoS 6**: Human-readable and well-formatted markdown files
7. **CoS 7**: Commit correlation with conversation timestamps
8. **CoS 8**: Multiple repositories handled concurrently
9. **CoS 9**: System stability for 8+ hour sessions
10. **CoS 10**: Large commits (>1000 lines) handled efficiently
11. **CoS 11**: Git repository errors handled gracefully

**Additional Scenarios**:
- Commits during active Cursor sessions
- Commits outside sessions
- Multiple commits per day
- Commits in different projects
- Merge commits
- Initial commits
- Detached HEAD state

**Success Criteria**:
- All 11 acceptance criteria verified
- Tests pass consistently
- Markdown format matches PRD
- Error handling works correctly
- System stable over extended periods

## Verification

- [ ] Test CoS 1: Repository discovery
- [ ] Test CoS 2: Commit detection
- [ ] Test CoS 3: Metadata extraction
- [ ] Test CoS 4: Diff extraction
- [ ] Test CoS 5: Directory structure
- [ ] Test CoS 6: Markdown format
- [ ] Test CoS 7: Commit correlation
- [ ] Test CoS 8: Multiple repositories
- [ ] Test CoS 9: Long-running stability
- [ ] Test CoS 10: Large commits
- [ ] Test CoS 11: Error handling
- [ ] All tests passing
- [ ] Test coverage adequate

## Files Modified

- `test/e2e/pbi3_cos_test.go` (new) - End-to-end tests for PBI 3 acceptance criteria

