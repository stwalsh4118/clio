# 3-9 Integrate git capture components into daemon

[Back to task list](./tasks.md)

## Description

Wire together all git capture components (repository discovery, polling, extraction, correlation, and export) and integrate with the existing daemon lifecycle. Coordinate git capture with Cursor capture system to enable commit-to-session correlation.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-11-16 00:55:17 | Created | N/A | Proposed | Task file created | System |

## Requirements

1. Create git capture service that orchestrates all components:
   - Repository discovery
   - Commit polling
   - Metadata extraction
   - Diff extraction
   - Commit-to-session correlation
   - Markdown export
2. Integrate with daemon lifecycle:
   - Start git capture on daemon start
   - Stop git capture on daemon shutdown
   - Handle errors gracefully (don't crash daemon)
3. Coordinate with Cursor capture system:
   - Access session manager for correlation
   - Share project detection logic where possible
4. Handle configuration:
   - Get watched directories from config
   - Get polling interval from config
   - Get storage paths from config
5. Manage git capture state:
   - Track discovered repositories
   - Track last seen commits per repository
   - Handle repository changes (added/removed)
6. Process commits in pipeline:
   - Poll for new commits
   - Extract metadata and diffs
   - Correlate with sessions
   - Export to markdown files

## Implementation Plan

1. Create git capture service:
   - Location: `internal/git/capture.go`
   - Package: `git`
2. Define capture service interface:
   ```go
   type GitCaptureService interface {
       Start() error
       Stop() error
   }
   ```
3. Implement capture service structure:
   ```go
   type CaptureService struct {
       config          *config.Config
       logger          logging.Logger
       db              *sql.DB
       discovery       DiscoveryService
       poller          PollerService
       extractor       ExtractorService
       diffService     DiffService
       correlation     CorrelationService
       exporter        ExporterService
       sessionManager  cursor.SessionManager // From PBI 2
       ctx             context.Context
       cancel          context.CancelFunc
   }
   ```
4. Implement service creation:
   - Initialize all git services (discovery, poller, extractor, diff, correlation, exporter)
   - Get session manager from cursor capture service
   - Create context for lifecycle management
5. Implement Start() method:
   - Discover repositories from watched directories
   - Initialize poller with discovered repositories
   - Start polling in background goroutine
   - Process poll results:
     - Extract metadata for new commits
     - Extract diffs for new commits
     - Correlate commits with sessions
     - Export commits to markdown files
6. Implement Stop() method:
   - Cancel context
   - Stop poller
   - Clean up resources
7. Integrate with daemon:
   - Update `internal/daemon/daemon.go`:
     - Add git capture service field
     - Create git capture service in NewDaemon()
     - Start git capture in Run()
     - Stop git capture in Shutdown()
   - Handle errors gracefully (log but don't crash)
8. Coordinate with Cursor capture:
   - Access session manager for correlation
   - Use same project detection logic if possible
   - Ensure both systems can run concurrently
9. Handle repository changes:
   - Periodically re-discover repositories (e.g., every 5 minutes)
   - Add new repositories to poller
   - Remove deleted repositories from poller
10. Write integration tests

## Test Plan

**Objective**: Verify git capture integrates correctly with daemon and coordinates with Cursor capture system.

**Test Scope**:
- Service integration
- Lifecycle management
- Component coordination
- Error handling

**Environment & Setup**:
- Use test daemon instance
- Mock git repositories
- Mock session manager
- Test with both Cursor and git capture running

**Key Test Scenarios**:
1. Git capture starts with daemon
2. Git capture stops with daemon shutdown
3. Repository discovery works on start
4. Polling starts correctly
5. Commits processed through pipeline
6. Commits correlated with sessions
7. Commits exported to markdown files
8. Handles errors gracefully (doesn't crash daemon)
9. Coordinates with Cursor capture
10. Handles repository changes (added/removed)
11. Graceful shutdown works correctly

**Success Criteria**:
- Git capture integrated with daemon
- Lifecycle managed correctly
- Components wired together correctly
- Commits processed end-to-end
- Error handling works
- Coordination with Cursor capture works

## Verification

- [ ] Git capture service created
- [ ] All components wired together
- [ ] Integrated with daemon lifecycle
- [ ] Start/stop functionality works
- [ ] Commits processed through pipeline
- [ ] Correlation with sessions works
- [ ] Export to markdown works
- [ ] Error handling implemented
- [ ] Coordination with Cursor capture works
- [ ] Repository changes handled
- [ ] Integration tests written and passing

## Files Modified

- `internal/git/capture.go` (new) - Git capture service orchestrator
- `internal/daemon/daemon.go` (updated) - Integrate git capture service
- `internal/git/capture_test.go` (new) - Integration tests for git capture
- `docs/api-specs/git/git-api.md` (updated) - API specification

