# 3-2 Implement git repository discovery service

[Back to task list](./tasks.md)

## Description

Implement a service to scan configured watched directories for git repositories, identify `.git` directories, and track repository paths and metadata. This component discovers all git repositories that should be monitored for commit activity.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-11-16 00:55:17 | Created | N/A | Proposed | Task file created | System |

## Requirements

1. Scan watched directories from config (`config.WatchedDirectories`) for git repositories
2. Identify `.git` directories (both regular and worktree formats)
3. Extract repository metadata:
   - Repository root path
   - Repository name (derived from directory name)
   - Git directory path
   - Whether it's a worktree
4. Handle nested repositories appropriately (avoid scanning into `.git` directories)
5. Support periodic re-scanning to detect new repositories or removed repositories
6. Store discovered repositories in a manageable structure
7. Get watched directories from config: `config.WatchedDirectories`

## Implementation Plan

1. Create repository discovery service:
   - Location: `internal/git/discovery.go`
   - Package: `git`
2. Define repository structure:
   ```go
   type Repository struct {
       Path     string
       Name     string
       GitDir   string
       IsWorktree bool
   }
   ```
3. Implement discovery interface:
   ```go
   type DiscoveryService interface {
       DiscoverRepositories(dirs []string) ([]Repository, error)
       FindGitRepositories(dir string) ([]Repository, error)
   }
   ```
4. Implement directory scanning:
   - Walk watched directories recursively
   - Skip `.git` directories during traversal
   - Detect `.git` as directory (normal repo) or file (worktree)
   - Extract repository root path (parent of `.git`)
   - Derive repository name from directory name
5. Handle edge cases:
   - Skip inaccessible directories (permissions)
   - Handle symlinks appropriately
   - Skip non-directory entries
   - Handle nested git repositories (submodules)
6. Return list of discovered repositories
7. Write unit tests with temporary directories

## Test Plan

**Objective**: Verify git repository discovery correctly identifies all git repositories in watched directories.

**Test Scope**:
- Directory scanning
- Git repository detection
- Metadata extraction
- Edge case handling

**Environment & Setup**:
- Use temporary directories for testing
- Create test git repositories
- Create test worktrees

**Key Test Scenarios**:
1. Discover repositories in single watched directory
2. Discover repositories in multiple watched directories
3. Discover nested repositories (submodules)
4. Detect worktree repositories
5. Skip non-git directories
6. Handle inaccessible directories gracefully
7. Handle symlinks correctly
8. Extract correct repository metadata
9. Skip scanning into `.git` directories

**Success Criteria**:
- All git repositories discovered correctly
- Repository metadata extracted accurately
- Nested repositories handled appropriately
- Worktrees detected correctly
- Non-git directories skipped
- Error handling works correctly

## Verification

- [ ] Discovery service implemented
- [ ] Watched directories scanned correctly
- [ ] Git repositories identified correctly
- [ ] Repository metadata extracted
- [ ] Nested repositories handled
- [ ] Worktrees detected
- [ ] Non-git directories skipped
- [ ] Error handling implemented
- [ ] Unit tests written and passing

## Files Modified

- `internal/git/discovery.go` (new) - Git repository discovery service
- `internal/git/discovery_test.go` (new) - Unit tests for discovery service
- `docs/api-specs/git/git-api.md` (updated) - API specification

