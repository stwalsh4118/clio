# 3-7 Implement markdown export for commits

[Back to task list](./tasks.md)

## Description

Implement functionality to export git commits to markdown files organized by date and project. The markdown files should follow the format specified in the PRD and be placed in the correct directory structure matching the session organization.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-11-16 00:55:17 | Created | N/A | Proposed | Task file created | System |

## Requirements

1. Export commits to markdown files
2. Organize by date: `~/.clio/sessions/YYYY-MM-DD/<project>/commits.md`
3. Format according to PRD specification:
   - Header with date: `# Git Activity: YYYY-MM-DD`
   - Commit sections with hash and time
   - Branch, author, and message information
   - Files changed list with statistics
   - Full diff in code block
4. Handle file appending for multiple commits per day
5. Ensure directory structure exists before writing
6. Handle concurrent writes safely
7. Integrate with commit metadata, diffs, and correlation from previous tasks
8. Use storage paths from config: `config.Storage.SessionsPath`

## Implementation Plan

1. Create markdown export service:
   - Location: `internal/git/exporter.go`
   - Package: `git`
2. Define export structures:
   ```go
   type CommitExport struct {
       Metadata    CommitMetadata
       Diff        CommitDiff
       Correlation CommitSessionCorrelation
   }
   ```
3. Implement export interface:
   ```go
   type ExporterService interface {
       ExportCommit(export CommitExport, basePath string) error
       ExportCommits(commits []CommitExport, basePath string) error
       FormatCommitMarkdown(export CommitExport) string
   }
   ```
4. Implement markdown formatting:
   - Format header: `# Git Activity: YYYY-MM-DD`
   - Format commit section:
     - `## Commit <hash> (<time>)`
     - `**Branch**: <branch>`
     - `**Author**: <author name>`
     - `**Message**: <message>`
   - Format files changed list:
     - `### Files Changed`
     - List with `- \`<path>\` (+<added>, -<removed>)`
   - Format diff:
     - `### Diff`
     - Code block with diff syntax highlighting
     - Handle truncated diffs with note
5. Implement file writing:
   - Construct file path: `{sessionsPath}/{YYYY-MM-DD}/{project}/commits.md`
   - Ensure directory structure exists
   - Append to file if it exists, create if not
   - Use file locking or atomic writes for concurrent safety
   - Handle file I/O errors gracefully
6. Handle multiple commits per day:
   - Append commits to existing file
   - Maintain chronological order
   - Add separator between commits if needed
7. Integration:
   - Use commit metadata from task 3-4
   - Use commit diff from task 3-5
   - Use correlation from task 3-6
   - Use project name from correlation or repository
8. Write unit tests with temporary directories

## Test Plan

**Objective**: Verify markdown export correctly formats and writes commits to files in the correct directory structure.

**Test Scope**:
- Markdown formatting
- File writing
- Directory structure creation
- Concurrent writes
- Multiple commits handling

**Environment & Setup**:
- Use temporary directories for testing
- Create test commits with various characteristics
- Test with multiple commits per day

**Key Test Scenarios**:
1. Export single commit to markdown file
2. Export multiple commits to same file (same day/project)
3. Export commits to different project directories
4. Format markdown correctly according to PRD
5. Handle file appending correctly
6. Create directory structure if missing
7. Handle concurrent writes safely
8. Handle large diffs with truncation note
9. Handle merge commits formatting
10. Handle commits with no correlation

**Success Criteria**:
- Markdown files created correctly
- Directory structure matches specification
- Format matches PRD specification
- Multiple commits appended correctly
- File I/O errors handled gracefully
- Concurrent writes handled safely

## Verification

- [ ] Export service implemented
- [ ] Markdown formatting matches PRD specification
- [ ] Files written to correct directory structure
- [ ] Directory structure created if missing
- [ ] Multiple commits appended correctly
- [ ] Concurrent writes handled safely
- [ ] File I/O errors handled
- [ ] Integration with metadata, diff, and correlation works
- [ ] Unit tests written and passing

## Files Modified

- `internal/git/exporter.go` (new) - Commit markdown export service
- `internal/git/exporter_test.go` (new) - Unit tests for exporter
- `docs/api-specs/git/git-api.md` (updated) - API specification

