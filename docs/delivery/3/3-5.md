# 3-5 Implement diff extraction

[Back to task list](./tasks.md)

## Description

Implement functionality to extract commit diffs from git commits, including full commit diffs and file-level statistics. Handle large diffs efficiently (>1000 lines) and track files with multiple edits in short time windows as debugging signals.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-11-16 00:55:17 | Created | N/A | Proposed | Task file created | System |
| 2025-11-16 18:00:00 | Status Update | Proposed | InProgress | Started implementation | AI Agent |
| 2025-11-16 18:30:00 | Status Update | InProgress | Review | Implementation complete, all tests passing | AI Agent |
| 2025-11-16 18:45:00 | Status Update | Review | Done | Task completed and verified | User |

## Requirements

1. Extract full commit diff (all changes in commit)
2. Extract file-level diffs with statistics:
   - Files changed
   - Lines added per file
   - Lines removed per file
   - File paths
3. Handle large diffs efficiently (>1000 lines):
   - Truncate diffs >5000 lines with note (per research from task 3-1)
   - Still extract file statistics for large commits
   - Indicate when diff is truncated
4. Track files with multiple edits (debugging signals):
   - Identify files edited multiple times in short time windows
   - This can indicate debugging activity
5. Format diffs in readable format (unified diff format)
6. Integrate with go-git library and commit metadata from task 3-4

## Implementation Plan

1. Create diff extraction service:
   - Location: `internal/git/diff.go`
   - Package: `git`
2. Define diff structures:
   ```go
   type CommitDiff struct {
       CommitHash string
       FullDiff   string
       Files      []FileDiff
       IsTruncated bool
       TruncatedAt int // Line count where truncated
   }
   
   type FileDiff struct {
       Path        string
       LinesAdded  int
       LinesRemoved int
       Diff        string
   }
   ```
3. Implement extraction interface:
   ```go
   type DiffService interface {
       ExtractDiff(repo Repository, commitHash string) (*CommitDiff, error)
       ExtractFileStats(repo Repository, commitHash string) ([]FileDiff, error)
   }
   ```
4. Implement diff extraction:
   - Open repository using go-git
   - Get commit object
   - Get parent commit (or empty tree for initial commit)
   - Generate patch between parent and commit
   - Extract unified diff format
   - Parse diff to extract file-level statistics
   - Count lines added/removed per file
5. Handle large diffs:
   - Check total diff line count
   - If >5000 lines, truncate diff but keep file statistics
   - Add note indicating truncation
   - Still include file list and statistics
6. Extract file statistics:
   - Parse unified diff format
   - Count `+` lines (additions)
   - Count `-` lines (deletions)
   - Extract file paths from diff headers
7. Format diff output:
   - Use unified diff format (standard git diff format)
   - Include file headers
   - Include hunk headers
8. Write unit tests with various commit types

## Test Plan

**Objective**: Verify diff extraction correctly extracts commit diffs and file statistics, handling large diffs efficiently.

**Test Scope**:
- Diff extraction
- File statistics extraction
- Large diff handling
- Format validation

**Environment & Setup**:
- Use temporary git repositories for testing
- Create commits with various diff sizes
- Create commits with multiple files changed
- Create large commits (>5000 lines)

**Key Test Scenarios**:
1. Extract diff from normal commit
2. Extract diff from commit with multiple files
3. Extract file statistics correctly
4. Handle large diffs (>5000 lines) with truncation
5. Extract diff from initial commit (no parent)
6. Extract diff from merge commit
7. Format diff correctly (unified format)
8. Count lines added/removed correctly
9. Handle empty commits gracefully
10. Handle binary file changes (skip or mark appropriately)

**Success Criteria**:
- Diffs extracted correctly
- File statistics accurate
- Large diffs handled efficiently
- Truncation works correctly
- Format is readable
- Error handling works correctly

## Verification

- [x] Diff extraction service implemented
- [x] Full commit diff extracted
- [x] File-level statistics extracted
- [x] Large diffs handled efficiently
- [x] Truncation implemented correctly
- [x] File statistics accurate
- [x] Diff format correct
- [x] Unit tests written and passing

## Files Modified

- `internal/git/extractor.go` (updated) - Implemented ExtractDiff method with truncation and file statistics
- `internal/git/extractor_test.go` (updated) - Added comprehensive unit tests for diff extraction
- `docs/api-specs/git/git-api.md` (updated) - Updated API specification to mark ExtractDiff as implemented

