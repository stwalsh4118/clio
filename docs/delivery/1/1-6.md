# 1-6 Add configuration validation

[Back to task list](./tasks.md)

## Description

Implement configuration validation to ensure config values, paths, and settings are valid before the application uses them. This prevents runtime errors and provides helpful error messages to users.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-11-14 01:41:47 | Created | N/A | Proposed | Task file created | System |
| 2025-01-27 00:00:00 | Status Change | Proposed | Done | Task completed - Comprehensive configuration validation implemented with security hardening | AI Agent |

## Requirements

1. Validate configuration values when loaded:
   - Watched directories must exist and be directories
   - Blog repository path must exist and be a directory (and optionally a git repository)
   - Storage paths must be valid and writable
   - Cursor log path must exist (if specified)
   - Session timeout must be a positive number
2. Provide clear, actionable error messages for validation failures
3. Validate configuration in multiple places:
   - When loading configuration
   - When modifying configuration via CLI commands
   - Before starting daemon
4. Prevent invalid configurations from being saved
5. Handle missing optional configuration gracefully

## Implementation Plan

1. Enhance `internal/config/validator.go` (created in task 1-4) with comprehensive validation:
   - `ValidateWatchedDirectories(dirs []string) error` - Check each directory exists and is readable
   - `ValidateBlogRepository(path string) error` - Check path exists, is directory, optionally check git repo
   - `ValidateStoragePaths(config StorageConfig) error` - Check base path exists and is writable
   - `ValidateCursorPath(path string) error` - Check path exists (if provided)
   - `ValidateSessionConfig(config SessionConfig) error` - Check timeout is positive
   - `ValidateConfig(config *Config) error` - Main validation function that calls all validators
2. Integrate validation into configuration loader:
   - Call `ValidateConfig()` after loading configuration
   - Return validation errors with helpful messages
3. Integrate validation into CLI commands:
   - Validate before saving configuration changes
   - Show validation errors before saving
4. Add validation to daemon start:
   - Validate configuration before starting daemon
   - Prevent daemon from starting with invalid config
5. Create validation error types that provide actionable guidance

## Test Plan

**Objective**: Verify configuration validation correctly identifies invalid settings and provides helpful error messages.

**Test Scope**:
- Path validation
- Value validation
- Configuration structure validation
- Error message quality
- Integration with config loader and CLI commands

**Key Test Scenarios**:
1. Valid configuration passes all validation checks
2. Non-existent watched directory fails validation with clear error
3. File path provided instead of directory fails validation
4. Non-writable storage path fails validation
5. Negative session timeout fails validation
6. Invalid blog repository path fails validation
7. Validation errors prevent saving invalid configuration
8. Validation errors prevent starting daemon with invalid config
9. Error messages are clear and actionable
10. Missing optional configuration is handled gracefully

**Success Criteria**:
- All validation rules are implemented
- Validation errors are clear and actionable
- Invalid configurations are prevented from being saved or used
- Validation integrates correctly with config loader and CLI commands

## Verification

- [x] Configuration validation functions implemented
- [x] Watched directories are validated
- [x] Blog repository path is validated
- [x] Storage paths are validated
- [x] Session configuration is validated
- [x] Validation errors prevent saving invalid config
- [x] Validation errors prevent starting daemon
- [x] Error messages are clear and helpful
- [x] Optional configuration is handled gracefully
- [x] Security hardening: watched directories restricted to home directory
- [x] Security hardening: sensitive system directories blocked
- [x] Security hardening: race condition fixes in checkWritable

## Files Modified

- `internal/config/validator.go` (updated with comprehensive validation)
- `internal/config/loader.go` (updated to call validation)
- `internal/cli/config.go` (updated to validate before saving)
- `internal/cli/start.go` (updated to validate before starting)


