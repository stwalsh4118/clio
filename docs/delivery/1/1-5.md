# 1-5 Implement start/stop/status commands

[Back to task list](./tasks.md)

## Description

Implement basic daemon process management commands: `clio start` (creates background daemon), `clio stop` (gracefully stops daemon), and `clio status` (reports daemon state). This provides the operational control for the monitoring service.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-11-14 01:41:47 | Created | N/A | Proposed | Task file created | System |

## Requirements

1. Implement `clio start` command that:
   - Creates a background daemon process
   - Stores PID in a PID file (e.g., `~/.clio/clio.pid`)
   - Handles case where daemon is already running
2. Implement `clio stop` command that:
   - Reads PID from PID file
   - Sends graceful shutdown signal to daemon process
   - Removes PID file after successful shutdown
   - Handles case where daemon is not running
3. Implement `clio status` command that:
   - Checks if PID file exists
   - Verifies process is still running
   - Reports daemon state (running/stopped)
4. Handle edge cases:
   - Stale PID files (process died but PID file remains)
   - Permission errors
   - Process already running errors

## Implementation Plan

1. Create `internal/cli/start.go` for start command:
   - Check if daemon is already running (check PID file and process)
   - Fork process to background (or use appropriate daemonization method)
   - Write PID to `~/.clio/clio.pid`
   - For now, daemon can be a placeholder that runs indefinitely (actual monitoring logic comes later)
2. Create `internal/cli/stop.go` for stop command:
   - Read PID from PID file
   - Verify process exists and is the clio daemon
   - Send SIGTERM signal for graceful shutdown
   - Wait for process to exit (with timeout)
   - Remove PID file
   - Handle errors gracefully
3. Create `internal/cli/status.go` for status command:
   - Check if PID file exists
   - If exists, verify process is running
   - Report status: "running" or "stopped"
   - Handle stale PID files
4. Create `internal/daemon/` package for daemon logic:
   - `internal/daemon/daemon.go` - Main daemon process structure
   - `internal/daemon/pid.go` - PID file management
   - `internal/daemon/signal.go` - Signal handling for graceful shutdown
5. Implement signal handling for graceful shutdown (SIGTERM, SIGINT)

## Test Plan

**Objective**: Verify start/stop/status commands correctly manage daemon process lifecycle.

**Test Scope**:
- Start command functionality
- Stop command functionality
- Status command functionality
- PID file management
- Process lifecycle management
- Error handling

**Key Test Scenarios**:
1. `clio start` creates background process and PID file
2. `clio start` when already running shows appropriate error
3. `clio status` reports "running" when daemon is active
4. `clio status` reports "stopped" when daemon is not running
5. `clio stop` gracefully stops running daemon
6. `clio stop` when not running shows appropriate message
7. Stale PID files are detected and handled correctly
8. Daemon responds to SIGTERM for graceful shutdown
9. PID file is created and removed correctly

**Success Criteria**:
- All three commands work as specified
- Daemon process management is reliable
- PID file handling is correct
- Error cases are handled gracefully
- Graceful shutdown works

## Verification

- [ ] `clio start` command exists and creates background daemon
- [ ] `clio stop` command exists and stops daemon gracefully
- [ ] `clio status` command exists and reports correct state
- [ ] PID file is created and managed correctly
- [ ] Already-running daemon is detected
- [ ] Stale PID files are handled
- [ ] Graceful shutdown works (SIGTERM handling)
- [ ] Error messages are helpful

## Files Modified

- `internal/cli/start.go` (new)
- `internal/cli/stop.go` (new)
- `internal/cli/status.go` (new)
- `internal/daemon/daemon.go` (new)
- `internal/daemon/pid.go` (new)
- `internal/daemon/signal.go` (new)

